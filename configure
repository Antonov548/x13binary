#!/bin/bash
## Emacs please make this -*- mode: shell-mode; -*-
##
##  configure -- Unix build preparation system
##
##  Copyright (C) 2015  Dirk Eddelbuettel 
##
##  This file is part of x13binary
##
##  x13binary is free software: you can redistribute it and/or modify
##  it under the terms of the GNU General Public License as published by
##  the Free Software Foundation, either version 2 of the License, or
##  (at your option) any later version.
##
##  x13binary is distributed in the hope that it will be useful,
##  but WITHOUT ANY WARRANTY; without even the implied warranty of
##  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
##  GNU General Public License for more details.
##
##  You should have received a copy of the GNU General Public License
##  along with x13binary.  If not, see <http://www.gnu.org/licenses/>.

## Check that we are on Unix
uname=$(type -P uname)
if [ "${uname}" = "" ]; then
    echo "You do not have uname so this is unlikely to be a Unix system. Exiting."
    exit -1
fi

## Check for Linux or OSX
: ${R_HOME=$(R RHOME)}
sysname=$(${R_HOME}/bin/Rscript -e 'cat(Sys.info()["sysname"])')
if [ ${sysname} == "Linux" ]; then
    platform="linux"
elif [ ${sysname} == "Darwin" ]; then
    platform="osx"
else
    platform=${sysname}
    echo "Unusual platform: ${sysname}"
    echo "Currently unsupported. Work needed."
    exit -1
    ## TODO: just build from source
fi

## helper function to not rely on curl which at least on OS X fails to follow redirects
download() {
    url=${1}
    ## sadly, for Travis we cannot rely on R as it lacks libcurl
    libcurl=$(${R_HOME}/bin/Rscript -e 'cat(capabilities()[["libcurl"]])')
    ## so when we have libcurl in R, use it -- else fall back to curl
    if [ ${libcurl} == "TRUE" ]; then
        file=$(basename ${url})
        ${R_HOME}/bin/Rscript -e "download.file(\"${url}\", \"${file}\", quiet=TRUE, method='libcurl')"
    else
        curl -s -k -L -O ${url}
    fi
}

cwd=$(pwd)

## On Linux, download binary
if [ ${platform} == "linux" ]; then
    cd inst/bin
    download https://github.com/x13org/x13prebuilt/raw/master/linux/x13ashtml
    echo "*** downloaded Linux binary"
    cd ${cwd}
elif [ if [ ${platform} == "osx" ]; then
    cd inst/bin
    # download https://github.com/x13org/x13prebuilt/raw/master/osx/x13ashtml.tar.gz
    # tar xfz x13ashtml.tar.gz
    echo TODO -- Create tarball of x13ashtml with libgfortran and libquadmath dylib
    cd ${cwd}
fi
    
exit 0

